---
title: サーバーのバックアップ
description: Setting up regular backups (optional, but not really)
menu:
  docs:
    weight: 80
    parent: admin
---

実際の環境で使用するときは、定期的にサーバーのバックアップをとってください。

## 概要 {#overview}

バックアップするべきもの（重要度順）：

1. PostgreSQL データベース
2. アプリケーションのシークレットコード（ `.env.production` ファイル、もしくは同等のもの）
3. ユーザーがアップロードしたファイル
4. Redis データベース

## 障害の種類 {#failure}

一般的に警戒すべき障害には2種類あります： ハードウェア障害。ディスク上のデータの破損、もしくは人為的・ソフトウェア的なエラー（誤ってファイルを消してしまうなど）。このドキュメントでは前者を扱います。

PostgreSQLのデータを失ってしまった場合は、完全にゲームオーバーです。Mastodonは全ての重要なデータをPostgreSQLデータベースに保存しています。もしデータベースを失ってしまったら、あなたのサーバー上のすべてのアカウント、投稿、フォロワーを失います。

アプリケーションシークレットを失ってしまった場合は、Mastodonのいくつかのユーザー向け機能が動作しなくなります。ユーザーは強制ログアウトされ、二段階認証は使用不可能になり、Web Push APIの購読が動作しなくなります。

ユーザーがアップロードしたファイルを失った場合は、ユーザーのアイコン、ヘッダー画像、添付メディアを失います。しかしMastodonは _動作し続けます。_

Redisデータベースを失った場合は、ほとんどの無害です。回復不可能なデータは、Sidekiqの実行待ち・再試行キューとデッドジョブです。ホームタイムラインとリストタイムラインは `tootctl` コマンドで再生成できます。

最適なバックアップは、オフサイトバックアップです。たとえば、Mastodonが動いているサーバー以外の場所に保存することです。もしホストしているサーバーが火事になってハードディスクドライブが爆発してしまったとしたら、同じハードディスクに保存されていたバックアップは使い物になりません。



## アプリケーションシークレットのバックアップ {#env}

アプリケーションシークレットのバックアップはもっとも簡単です。それらは変更されることがありませんから、 `.env.production` ファイルを安全な場所にコピーしておくだけです。


## PostgreSQLのバックアップ {#postgresql}

PostgreSQLには、突然の電源断・ハードディスクの故障・スキーマのマイグレーションの失敗などによって、データ破損のリスクがあります。そのため、時折 `pg_dump` や `pg_dumpall` コマンドによってバックアップを作成することが推奨されます。

高可用性セットアップを行う場合は、オンラインレプリケーションを使ってサブのPostgreSQLサーバーに最新データを保存しておき、メインのサーバーがダウンした場合に切り替えができるよう備えることができます。


## ユーザーがアップロードしたファイルのバックアップ {#media}

もし、Amazon S3やGoogle Cloud、Wasabiなどの外部オブジェクトストレージを使用している場合は、それらのバックアップについて心配することはありません。それぞれの業者がハードウェア障害に対処します。

ローカルファイルストレージを使用している場合は、アップロードされたファイルが保存される `public/system` ディレクトリをコピーします。


## Redisのバックアップ {#redis}

Redisのバックアップは簡単です。Redisは通常 `/var/lib/redis/dump.rdb` ファイルにデータを書き込みますので、そのファイルのコピーを取得するだけです。


